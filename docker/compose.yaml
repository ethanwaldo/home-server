# FILE: /home/waldo/server/docker/compose.yaml

services:
    # --- Dynamic DNS Service ---

    # DDClient - automatic DNS record updates when public IP changes
    ddclient:
        image: lscr.io/linuxserver/ddclient:latest
        container_name: ddclient
        restart: unless-stopped
        environment:
            - PUID=1000 # User ID for file permissions
            - PGID=1003 # Group ID for file permissions
            - TZ=America/New_York # Timezone for logs and scheduling
            - PORKBUN_API_KEY=${PORKBUN_API_KEY} # Porkbun API key from env file
            - PORKBUN_SECRET_KEY=${PORKBUN_SECRET_KEY} # Porkbun secret from env file
        volumes:
            - ./config/ddclient/ddclient.conf:/config/ddclient.conf # DDClient configuration

    # --- Reverse Proxy & Web Server ---

    # Caddy - handles HTTPS, reverse proxy, and static file serving
    caddy:
        image: caddy:latest
        container_name: caddy
        restart: unless-stopped
        network_mode: host # Direct host network access for port 80/443
        volumes:
            - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile # Reverse proxy configuration
            - ../site:/srv # Static website files
            - caddy_data:/data # TLS certificates and cache
            - caddy_config:/config # Caddy runtime configuration

    # --- VPN Server ---

    # Headscale - self-hosted Tailscale coordination server
    headscale:
        image: headscale/headscale:latest
        container_name: headscale
        restart: unless-stopped
        network_mode: host # Direct network access for VPN coordination
        volumes:
            - ./config/headscale/config.yaml:/etc/headscale/config.yaml:ro # Headscale config (read-only)
            - headscale_data:/var/lib/headscale # Database and keys
        dns:
            - 8.8.8.8 # Google DNS for external queries
            - 1.1.1.1 # Cloudflare DNS backup
        command: serve # Start headscale server
        depends_on:
            - ddclient # Wait for DNS updates before starting

    # --- Tree Gnome AI Assistant API ---
    
    # Tree Gnome - OSRS AI assistant backend
    tree-gnome:
        build:
            context: /opt/tree-gnome
            dockerfile: Dockerfile
        container_name: tree-gnome
        restart: unless-stopped
        network_mode: host # Access to localhost:8000
        volumes:
            - /opt/tree-gnome-data:/app/osrs_raw_data # Persistent database
        environment:
            - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}

    # Tree Gnome Frontend
    tree-gnome-frontend:
        build:
            context: /opt/tree-gnome/frontend
            dockerfile: Dockerfile
        container_name: tree-gnome-frontend
        restart: unless-stopped
        network_mode: host # Access to localhost:3000

    # Graph Explorer - New static site backend
    graph-explorer:
        build:
            context: ../site
            dockerfile: Dockerfile
        container_name: graph-explorer
        restart: unless-stopped
        network_mode: host # Access to localhost:8050

    # --- Task Slayer - College Project ---

    task-slayer-frontend:
        build:
            context: ../task-slayer/client
            target: ${NODE_ENV:-dev} # Use 'prod' on the Pi
        container_name: task-slayer-frontend
        restart: always
        environment:
            - VITE_API_URL=/api
        network_mode: host # Access via port 3001 (configured in Vite/Nginx)

    task-slayer-backend:
        build:
            context: ../task-slayer/server
        container_name: task-slayer-backend
        restart: always
        environment:
            - PORT=5001
            - MONGO_URI=mongodb://localhost:27017/taskslayer
            - NODE_ENV=${NODE_ENV:-development}
        network_mode: host # Access via port 5001

    task-slayer-mongodb:
        image: mongo:latest
        container_name: task-slayer-mongodb
        restart: always
        network_mode: host # Access via port 27017
        volumes:
            - task_slayer_mongodb_data:/data/db

# --- Persistent Storage ---

# Named volumes for container data persistence
volumes:
    caddy_data: # TLS certificates and Caddy cache
    caddy_config: # Caddy runtime configuration
    headscale_data: # VPN server database and encryption keys
    task_slayer_mongodb_data: # Task Slayer database
